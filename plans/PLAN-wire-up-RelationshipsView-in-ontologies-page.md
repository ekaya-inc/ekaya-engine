# PLAN: Wire Up RelationshipsView in Ontology Page

## Goal

Display the entity-to-entity relationship graph on the Ontology page after extraction completes.

## Current State

### Component Exists But Is Orphaned
- `ui/src/components/ontology/RelationshipsView.tsx` exists
- Not imported or used anywhere
- Shows entity relationships as a simple list: "Entity A â†’ Entity B (type)"

### Data Exists But Isn't Displayed
- `engine_ontologies.domain_summary->'relationship_graph'` contains the data
- Generated by OntologyFinalization (DAG stage 7)
- Example edge: `{"from": "User", "to": "Account", "label": "Links a user to their account..."}`

### Type Mismatch (Bug)
**Backend** (`pkg/models/ontology.go:26`):
```go
type RelationshipEdge struct {
    From        string `json:"from"`
    To          string `json:"to"`
    Label       string `json:"label,omitempty"`      // â† Backend sends "label"
    Cardinality string `json:"cardinality,omitempty"`
}
```

**Frontend** (`ui/src/types/ontology.ts:215`):
```typescript
export interface RelationshipEdge {
    from: string;
    to: string;
    type: string;  // â† Frontend expects "type" (WRONG!)
}
```

**Component** (`ui/src/components/ontology/RelationshipsView.tsx:38`):
```typescript
â€¢ <strong>{rel.from} â†’ {rel.to}</strong> ({rel.type})  // Uses rel.type
```

### OntologyPage Has No Post-Extraction Content
- `ui/src/pages/OntologyPage.tsx` only shows the DAG visualization
- No section for viewing extracted ontology data

### API Available
- `GET /api/projects/{project_id}/ontology/result` returns:
```typescript
interface WorkflowResultResponse {
    workflow_id: string;
    tiered_ontology?: {
        domain_summary: {
            relationship_graph: RelationshipEdge[];
            // ... other fields
        };
        // ...
    };
}
```

## Implementation

### 1. Fix TypeScript Type

**File**: `ui/src/types/ontology.ts` (line 215)

```typescript
export interface RelationshipEdge {
    from: string;
    to: string;
    label?: string;       // CHANGE: was "type"
    cardinality?: string; // ADD: matches backend
}
```

### 2. Update RelationshipsView Component

**File**: `ui/src/components/ontology/RelationshipsView.tsx`

Update to use `label` instead of `type`, and improve the display:

```typescript
import { GitBranch } from 'lucide-react';

import type { RelationshipEdge } from '../../types/ontology';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '../ui/Card';

interface RelationshipsViewProps {
  relationships?: RelationshipEdge[];
}

const RelationshipsView = ({ relationships }: RelationshipsViewProps) => {
  if (!relationships || relationships.length === 0) {
    return null; // Don't render empty card
  }

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center gap-2">
          <GitBranch className="h-5 w-5 text-purple-500" />
          <CardTitle>Entity Relationships</CardTitle>
        </div>
        <CardDescription>
          {relationships.length} relationship{relationships.length !== 1 ? 's' : ''} discovered
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {relationships.map((rel, index) => (
            <div key={index} className="border-l-2 border-purple-200 pl-3">
              <div className="font-medium text-text-primary">
                {rel.from} â†’ {rel.to}
              </div>
              {rel.label && (
                <p className="text-sm text-text-secondary mt-1">
                  {rel.label}
                </p>
              )}
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
};

export default RelationshipsView;
```

### 3. Update OntologyPage to Fetch and Display

**File**: `ui/src/pages/OntologyPage.tsx`

Add state, fetch logic, and render the component:

```typescript
// Add imports
import RelationshipsView from '../components/ontology/RelationshipsView';
import ontologyApi from '../services/ontologyApi';
import type { RelationshipEdge } from '../types/ontology';

// Inside component, add state
const [relationshipGraph, setRelationshipGraph] = useState<RelationshipEdge[]>([]);

// Update handleComplete callback to fetch results
const handleComplete = useCallback(async () => {
  console.log('Ontology extraction complete');
  if (pid) {
    try {
      const result = await ontologyApi.getWorkflowResult(pid);
      if (result.tiered_ontology?.domain_summary?.relationship_graph) {
        setRelationshipGraph(result.tiered_ontology.domain_summary.relationship_graph);
      }
    } catch (err) {
      console.error('Failed to fetch ontology result:', err);
    }
  }
}, [pid]);

// Also fetch on mount if ontology already exists
useEffect(() => {
  if (pid && hasOntology) {
    ontologyApi.getWorkflowResult(pid)
      .then(result => {
        if (result.tiered_ontology?.domain_summary?.relationship_graph) {
          setRelationshipGraph(result.tiered_ontology.domain_summary.relationship_graph);
        }
      })
      .catch(console.error);
  }
}, [pid, hasOntology]);

// In render, add after DAG component (around line 132)
{hasOntology && relationshipGraph.length > 0 && (
  <div className="mt-6">
    <RelationshipsView relationships={relationshipGraph} />
  </div>
)}
```

## File Summary

| File | Action | Changes |
|------|--------|---------|
| `ui/src/types/ontology.ts` | Modify | Fix `RelationshipEdge` interface: `type` â†’ `label`, add `cardinality` |
| `ui/src/components/ontology/RelationshipsView.tsx` | Modify | Use `label` instead of `type`, improve styling |
| `ui/src/pages/OntologyPage.tsx` | Modify | Import component, add state, fetch on complete/mount, render |

## UI Design

After extraction completes, the Ontology page will show:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§  Ontology Extraction                                                   â”‚
â”‚ Extract business knowledge from your database schema                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚ [DAG Visualization - showing completed stages]                           â”‚
â”‚                                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”€ Entity Relationships                                                  â”‚
â”‚ 29 relationships discovered                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ User â†’ Account                                                         â”‚
â”‚ â”‚ Links a user to their account, establishing the primary membership     â”‚
â”‚ â”‚ relationship. This represents the user's direct access and permissions â”‚
â”‚ â”‚ within their account.                                                  â”‚
â”‚                                                                          â”‚
â”‚ â”‚ User Follow â†’ User                                                     â”‚
â”‚ â”‚ Identifies the user being followed in a follow relationship. A user    â”‚
â”‚ â”‚ can be followed by many other users.                                   â”‚
â”‚                                                                          â”‚
â”‚ â”‚ Channel â†’ Account                                                      â”‚
â”‚ â”‚ Associates each Channel with the Account that owns and operates it.    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Testing

1. **Type fix**: Verify no TypeScript errors after changing `type` to `label`

2. **API test**: Verify data exists:
   ```bash
   curl http://localhost:3443/api/projects/{pid}/ontology/result | jq '.tiered_ontology.domain_summary.relationship_graph | length'
   ```

3. **Visual test**:
   - Go to Ontology page with completed extraction
   - Verify RelationshipsView card appears below DAG
   - Verify entity names and labels display correctly

4. **Empty state**: Verify card doesn't render when no relationships exist

## Notes

- The relationship graph is entity-to-entity (e.g., "User â†’ Account"), not table-to-table
- Labels are LLM-generated descriptions explaining the business meaning
- This is different from the Relationships page which shows FK/inferred relationships at the column level
- Consider future enhancement: clickable entities to navigate to entity details
