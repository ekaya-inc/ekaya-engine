name: Pull Request Checks

on:
  pull_request:
    branches: [main, prod]
    types: [opened, synchronize, reopened]

env:
  GO_VERSION: '1.23'
  TEST_IMAGE: us-central1-docker.pkg.dev/ekaya-dev-shared/ekaya-dev-containers/ekaya-engine-test-image:latest

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write # Required for Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: |
          go mod download
          # Install golangci-lint for strict checking
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v2.4.0
          # Install frontend dependencies
          cd ui && npm ci

      # GCP auth may fail for PRs from forks due to Workload Identity Federation restrictions
      - name: Authenticate to Google Cloud
        id: auth
        continue-on-error: true
        uses: google-github-actions/auth@v2
        with:
          token_format: 'access_token'
          workload_identity_provider: ${{ secrets.DEV_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.DEV_SERVICE_ACCOUNT_EMAIL }}
          project_id: ${{ secrets.DEV_GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        if: steps.auth.outcome == 'success'
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        if: steps.auth.outcome == 'success'
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Pull test database image
        if: steps.auth.outcome == 'success'
        run: docker pull ${{ env.TEST_IMAGE }}

      # Run full checks if test image is available, otherwise skip integration tests
      - name: Run all quality checks
        if: steps.auth.outcome == 'success'
        run: make check

      - name: Run quality checks (without integration tests)
        if: steps.auth.outcome != 'success'
        run: |
          echo "⚠️ GCP auth unavailable - running checks without integration tests"
          echo "Integration tests will run on merge to main"
          # Run format and lint checks
          go mod tidy
          gofmt -l .
          golangci-lint run --timeout=5m
          # Run unit tests only (skip integration tests that need test image)
          go test ./... -short -cover -timeout 2m
          # Frontend checks
          cd ui && npm run lint && npm run typecheck && npm test -- --run

      - name: Generate coverage report
        if: steps.auth.outcome == 'success'
        run: go test -race -coverprofile=coverage.txt -covermode=atomic ./... -timeout 5m

      - name: Generate coverage report (unit tests only)
        if: steps.auth.outcome != 'success'
        run: go test -race -short -coverprofile=coverage.txt -covermode=atomic ./... -timeout 2m

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.txt
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false # Don't fail PR if coverage upload fails


  # Security scanning disabled until GitHub Advanced Security is enabled for private repos
  # To re-enable: uncomment this job after upgrading GitHub plan
  # security:
  #   name: Security Scan
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     security-events: write
  #     actions: read  # Required for private repositories

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version: ${{ env.GO_VERSION }}

  #     - name: Run gosec Security Scanner
  #       uses: securego/gosec@master
  #       with:
  #         args: '-no-fail -fmt sarif -out results.sarif ./...'

  #     - name: Upload SARIF file
  #       if: always()
  #       uses: github/codeql-action/upload-sarif@v3
  #       with:
  #         sarif_file: results.sarif

  #     - name: Run go mod audit
  #       run: |
  #         go list -json -m all | nancy sleuth || true

  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [validate]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        run: |
          go build -race -ldflags="-w -s" -o /tmp/ekaya-engine main.go
          echo "Binary built successfully"

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ekaya-engine:pr-${{ github.event.pull_request.number }}
