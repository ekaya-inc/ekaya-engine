#!/bin/sh
# Pre-push hook for ekaya-engine
# Runs comprehensive checks before pushing to remote

set -e

echo "ğŸš€ Running pre-push checks for production service..."
echo "This may take a minute due to comprehensive testing..."

# Check if we're in the right directory
if [ ! -f "go.mod" ]; then
    echo "âŒ Error: Not in Go project root directory"
    exit 1
fi

# Get the remote branch being pushed to
remote="$1"
url="$2"

# Check if pushing to main or prod branches
protected_branch='(main|prod|master|production)'
while read local_ref local_sha remote_ref remote_sha
do
    if echo "$remote_ref" | grep -qE "refs/heads/$protected_branch"; then
        echo "âš ï¸  Pushing to protected branch: $remote_ref"
        echo "Running comprehensive checks..."
        
        # Run full make check
        echo "ğŸ“‹ Running make check..."
        if make check; then
            echo "âœ… Make check passed"
        else
            echo "âŒ Make check failed. Fix issues before pushing to $remote_ref"
            exit 1
        fi
        
        # Check if linter is installed and run it strictly
        if command -v golangci-lint >/dev/null 2>&1; then
            echo "ğŸ” Running strict linter checks..."
            if golangci-lint run; then
                echo "âœ… Linter checks passed"
            else
                echo "âŒ Linter found issues. Fix them before pushing to $remote_ref"
                exit 1
            fi
        else
            echo "âš ï¸  golangci-lint not found, skipping strict lint checks"
        fi
    else
        # For feature branches, run lighter checks
        echo "ğŸ“ Running basic checks for feature branch..."
        
        # Just run formatting and basic tests
        if ! gofmt -l . | grep -q .; then
            echo "âœ… Code formatting OK"
        else
            echo "âŒ Formatting issues found. Run 'go fmt ./...'"
            exit 1
        fi
        
        if go test -short -timeout 1m ./... >/dev/null 2>&1; then
            echo "âœ… Unit tests passed"
        else
            echo "âŒ Unit tests failed"
            exit 1
        fi
    fi
done

echo "âœ… All pre-push checks passed! Safe to push."